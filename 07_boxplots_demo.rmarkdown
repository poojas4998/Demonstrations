---
title: "07_boxplot_demo"
format: html
editor: visual
---

```{r}
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(purrr))
suppressPackageStartupMessages(library(tibble))
suppressPackageStartupMessages(library(SeuratObject))
suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(patchwork))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(plyr))

# Function to save plot as PNG
save_plot_as_png <- function(plot, filename) {
  png(filename, res = 250, width = 4000, height = 2000)
  print(plot)
  dev.off()
}
```



# Why was it done?

Solid-tumor T-cell engineering often yieldsÂ **condition-specific**Â transcriptional effects. You wanted a fast, reproducible screen to (1)Â **flag genes that are selectively elevated**Â in one sample/condition relative to all others, and (2)Â **visualize**those differences at whole-dataset and per-cell-type levels with simple stats. This helps prioritize candidate markers/pathways for follow-up (e.g., enrichment, synergy checks, validation).

# Objective

-   **Primary:**Â Identify genes whose mean expression isÂ **substantially higher in one sample**Â than the average of the remaining samples, andÂ **summarize/visualize**Â those genes overall and by cell type.

-   **Operational thresholds:**Â keep genes expressed in â‰¥5% of cells; call a gene â€œselectively highâ€ if its fold change (FC) in any sample vs. the mean of others isÂ **\> 2.5**.

# Summary (what the pipeline does)

1.  ComputeÂ **per-sample average expression**Â for all genes (RNA assay).

2.  Filter to genes expressed inÂ **â‰¥5%**Â of cells.

3.  For each gene, compute aÂ **sample-wise FC**Â = (sample mean) / (mean of other samples).

4.  Keep genes withÂ **FC \> 2.5**Â inÂ *any*Â sample â‡’ write toÂ `preliminary/significant_foldchange_genes.csv`.

5.  For each retained gene, generate:

    -   **All-cells boxplots**Â across samples with pairwiseÂ **Wilcoxon**Â p-value annotations.

    -   **Per-cell-type boxplots**Â (same tests within each cell type).

    -   **Combined panels**Â (all-cells + each cell type) via cowplot.

6.  Save plots underÂ `plots/all_cells/`,Â `plots/per_celltype/<celltype>/`, andÂ `plots/cowplot_combined/`.



```{r}
#load("../data/demo_data_annotated_nobiomart.RData") 
#loading this later
load("../data/demo_data_annotated_biomart.RData")
```



# Synergy Genes Table

from 06_synergy_demo.qmd I saved the following

``` r
write.csv2(exclusive_genes_list_synergy$`4R_12R`,"4R_12R_exclusive_genes_list_synergy.csv")
```

# and Now i will read

synergy_genes



```{r}
synergy_genes_table <- read.csv2("4R_12R_exclusive_genes_list_synergy.csv")

if (!"gene_name" %in% names(synergy_genes_table)) {
  names(synergy_genes_table)[2] <- "gene_name"
}
synergy_genes_table$gene_name <- trimws(synergy_genes_table$gene_name)

head(synergy_genes_table,20)
```



converting using biomart



```{r}
#counts <- GetAssayData(demo_data, assay = "RNA", layer = "counts")
ensembl_ids <- synergy_genes_table$gene_name
library(biomaRt)
mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")
gene_map <- getBM(
  attributes = c("ensembl_gene_id", "mgi_symbol"),
  filters = "ensembl_gene_id",
  values = ensembl_ids,
  mart = mart
)
gene_map_unique <- gene_map[!duplicated(gene_map$ensembl_gene_id), ]
head(gene_map_unique,20)
```

```{r}
synergy_genes_table$mapped_gene_name <- gene_map_unique$mgi_symbol[match(synergy_genes_table$gene_name, gene_map_unique$ensembl_gene_id)]
synergy_genes_table$mapped_gene_name[is.na(synergy_genes_table$mapped_gene_name)] <- as.character(synergy_genes_table$mapped_gene_name[is.na(synergy_genes_table$mapped_gene_name)])

head(synergy_genes_table,20)

synergy_genes <- synergy_genes_table$mapped_gene_name
```



# Methods (code â†’ analysis steps)

-   **Data setup:**Â `DefaultAssay(demo_data) <- "RNA"`. UseÂ `AverageExpression(..., group.by = "samples")`to get a gene Ã— sample matrix of means.

-   **Expression filter:**Â `min_cells = 0.05 * ncol(demo_data)`; keep genes with counts\>0 in â‰¥ min_cells (`Matrix::rowSums(...)`).

-   **Per-sample fold change:**Â For each gene row, loop over samplesÂ *i*Â and computeÂ `this_val / mean(other_vals)`, withÂ `1e-6`Â for numerical stability.

-   **Hit list:**Â select genes with FC\>2.5 in any column.

-   **Statistics & plotting:**

    -   Build long data frames viaÂ `FetchData(..., vars = c(gene, "samples"))`.

    -   **Boxplots**Â (no outliers drawn) +Â **pairwise Wilcoxon**Â viaÂ `ggpubr::stat_compare_means`Â across all sample pairs.

    -   Ensure sample ordering (placesÂ `"box"`Â first in the legend/axis if present).

    -   **Per-cell-type**Â subsets usingÂ `metadata$cell_annotation`Â to stratify.

    -   Combine panels withÂ `cowplot::plot_grid`, save PNGs (300 dpi).

# Tasks automated

-   Gene-levelÂ **screening**Â for selective up-regulation by sample.

-   BatchÂ **plot generation**Â (overall and per cell type) with inlineÂ **p-value labels**.

-   StructuredÂ **file outputs**Â for easy review and downstream use.



```{r}
# genes, samples, conditions.
library(Seurat)
library(dplyr)
library(ggplot2)

# Set default assay
DefaultAssay(demo_data) <- "RNA"

# Step 1: Compute average gene expression per sample
avg_exp <- AverageExpression(demo_data, group.by = "samples", return.seurat = FALSE)$RNA

min_cells <- 0.02 * ncol(demo_data)
keep_genes <- rownames(demo_data)[Matrix::rowSums(GetAssayData(demo_data, slot = "counts") > 0) >= min_cells]

# Subset average expression
avg_exp_filtered <- avg_exp[rownames(avg_exp) %in% keep_genes, ]


# Step 2: Compute fold change of each gene in each sample compared to mean of other samples
fc_matrix <- apply(avg_exp_filtered , 1, function(x) {
  sapply(seq_along(x), function(i) {
    this_val <- x[i]
    other_avg <- mean(x[-i])
    return(this_val / (other_avg + 1e-6))  # avoid division by zero
  })
})

# Step 3: Transpose and convert to dataframe
fc_df <- as.data.frame(t(fc_matrix))
colnames(fc_df) <- colnames(avg_exp_filtered )
fc_df$gene <- rownames(avg_exp_filtered)


# Step 4: Filter genes with fold change > 1.5 in any sample
sig_genes <- fc_df[rowSums(fc_df[, -ncol(fc_df)] > 2.5) > 0, ]


# these exclusive_genes_list_synergy is from the 06_synergy_demo.qmd
genes_in_common <- sig_genes %>%
 dplyr::filter(gene %in% synergy_genes)

genes_in_common


# write.csv(sig_genes, "significant_foldchange_genes.csv", row.names = FALSE)

```

```{r}
library(Seurat)
library(ggplot2)
library(ggpubr)
library(dplyr)

# ---------------- Setup ----------------
DefaultAssay(demo_data) <- "RNA"
expr_matrix <- GetAssayData(demo_data, slot = "data")  # assumes NormalizeData done
metadata <- demo_data@meta.data

# Get a CHARACTER VECTOR of gene names (not rows of df)
top_genes <- genes_in_common$gene
top_genes <- head(unique(genes_in_common$gene), 4)

celltypes <- unique(metadata$cell_annotation)

# Helper: boxplot
plot_box <- function(df, gene, title_prefix) {
  boxplot1 <- ggplot(df, aes(x = samples, y = expression, fill = samples)) +
    geom_boxplot(outlier.shape = NA, width = 0.6, color = "black") +
    stat_compare_means(
      method = "wilcox.test",
      comparisons = combn(levels(factor(df$samples)), 2, simplify = FALSE),
      label = "p.signif"
    ) +
    theme_minimal(base_size = 13) +
    ggtitle(paste(title_prefix, gene)) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    ylab("Expression Level") + xlab("Sample")
  return(boxplot1)
}
```

```{r}
# Create base directories
dir.create("plots/all_cells", recursive = TRUE, showWarnings = FALSE)
dir.create("plots/per_celltype", recursive = TRUE, showWarnings = FALSE)

# ---------------- General Boxplots (All Cells) ----------------
cat("ğŸ“¤ Saving all-cells boxplots...\n")
n_all <- 0

for (g in top_genes) {
  # scalar checks only
  if (!(g %in% rownames(expr_matrix))) next

  file_path <- file.path("plots/all_cells", paste0(g, "_boxplot.png"))
  if (file.exists(file_path)) next

  # use the SAME object you prepared (demo_data)
  df <- FetchData(demo_data, vars = c(g, "samples")) %>%
    setNames(c("expression", "samples"))

  p <- plot_box(df, g, title_prefix = "All Cells â€” ")

  ggsave(filename = file_path, plot = p, width = 7, height = 5, dpi = 300)
  n_all <- n_all + 1
}
print(p)
cat("âœ… New all-cell plots saved:", n_all, "\n")

```

```{r}

# ---------------- Per-Celltype Boxplots ----------------
cat("ğŸ“¤ Saving per-celltype boxplots...\n")
n_ct <- 0

for (g in top_genes) {
  if (!(g %in% rownames(expr_matrix))) next

  for (ct in celltypes) {
    out_dir <- file.path("plots/per_celltype", gsub("[/ ]", "_", ct))
    dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

    file_path <- file.path(out_dir, paste0(g, "_", gsub("[/ ]", "_", ct), ".png"))
    if (file.exists(file_path)) next

    cell_ids <- rownames(metadata)[metadata$cell_annotation == ct]
    cell_ids <- intersect(cell_ids, colnames(expr_matrix))
    if (length(cell_ids) < 2) next  # need â‰¥2 for boxplot + stats

    df <- data.frame(
      expression = as.numeric(expr_matrix[g, cell_ids]),
      samples    = metadata[cell_ids, "samples", drop = TRUE],
      stringsAsFactors = FALSE
    )

    p <- plot_box(df, g, title_prefix = paste("Cell Type:", ct, "â€”"))
    ggsave(filename = file_path, plot = p, width = 7, height = 5, dpi = 300)
    n_ct <- n_ct + 1
  }
}
print(p)
cat("âœ… New per-celltype plots saved:", n_ct, "\n")
```

```{r}
library(cowplot)

dir.create("plots/cowplot_combined", recursive = TRUE, showWarnings = FALSE)

# Loop over genes
for (gene in top_genes) {
  if (!(gene %in% rownames(expr_matrix))) next

  plots <- list()

  # All cells plot
  df_all <- FetchData(demo_data, vars = c(gene, "samples")) %>%
    setNames(c("expression", "samples"))
  plots[[1]] <- plot_box(df_all, gene, title_prefix = "All Cells â€” ")

  # Per-celltype plots
  for (ct in celltypes) {
    cell_ids <- rownames(metadata %>% filter(cell_annotation == ct))
    expr_values <- expr_matrix[gene, cell_ids]

    df <- data.frame(
      expression = as.numeric(expr_values),
      samples = metadata[cell_ids, "samples"]
    )
    plots[[length(plots) + 1]] <- plot_box(df, gene, title_prefix = paste("Cell Type:", ct, "â€”"))
  }

  # Combine and save
  combined <- cowplot::plot_grid(plotlist = plots, ncol = 2)
  ggsave(filename = paste0("plots/cowplot_combined/", gene, "_combined.png"),
         plot = combined, width = 14, height = 8, dpi = 300)
}
```



```         
Warning in wilcox.test.default(c(0, 0, 0, 0, 0, 0), c(0.707499905428215,  :
  cannot compute exact p-value with ties

HAPPENS BECAUSE

Those warnings are from the Wilcoxon rank-sum test inside stat_compare_means().
They happen when your two groups have many tied values (e.g., lots of 0â€™s in scRNA-seq), so the test canâ€™t compute the exact p-value and falls back to an asymptotic one.
This is normal for zero-inflated single-cell data and doesnâ€™t invalidate the plot; itâ€™s just telling you why it switched methods.
```

# Results

-   **Hit count:**Â `N`Â genes passed FC\>2.5 in â‰¥1 sample (seeÂ `significant_foldchange_genes.csv`).

-   **Top examples:**Â e.g.,Â `GeneA`,Â `GeneB`,Â `GeneC`Â peak inÂ **Sample X**;Â `GeneD`Â peaks inÂ **Sample Y**.

-   **Per-cell-type specificity:**Â In cell typeÂ **T**,Â `GeneA`Â remains highest inÂ **Sample X**Â (Wilcoxon p \< 0.01 across comparisons), suggesting true condition-specific regulation rather than compositional effects.

-   **Figure references:**

    -   All-cells boxplots:Â `plots/all_cells/<gene>_boxplot.png`

    -   Per-cell-type boxplots:Â `plots/per_celltype/<celltype>/<gene>_<celltype>.png`

    -   Combined panels:Â `plots/cowplot_combined/<gene>_combined.png`

# Interpretation & caveats

-   **What it tells you:**Â a quick, interpretable list ofÂ **condition-selective genes**, with visual confirmation globally and within cell types.

-   **Caveats:**

    -   UsingÂ **means**Â on scRNA-seq can be influenced by zero inflation and rare high expressers; consider alsoÂ **median**Â orÂ **trimmed mean**Â and/orÂ **pseudobulk**Â per sample.

    -   Pairwise Wilcoxon across many sample pairs per gene introducesÂ **multiple-testing**Â concernsâ€”treat p-labels as screening hints, and confirm in a DE framework if you plan claims.

    -   If â€œboxâ€ is a non-biological control/batch, keep it for QC but avoid over-interpreting biological contrasts against it.

